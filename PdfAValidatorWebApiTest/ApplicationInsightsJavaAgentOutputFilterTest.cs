using PdfAValidatorWebApi;
using System.Xml;
using Xunit;

namespace CodeuctivityWebApiTest

{
    public class ApplicationInsightsJavaAgentOutputFilterTest
    {
        private const string azureConsoleOutputSample = "2022-06-02 21:21:14.830Z DEBUG c.m.a.a.b.d.etw.EtwProvider - EtwProvider initialized. Lib path=D:\\local\\Temp\\AISDK\\native\\3.2.0\\applicationinsights-java-etw-provider-x86-64.dll\r\n2022-06-02 21:21:14.908Z INFO  i.o.javaagent.tooling.VersionLogger - opentelemetry-javaagent - version: null\r\n2022-06-02 21:21:26.538Z INFO  c.m.applicationinsights.agent - ApplicationInsights Java Agent 3.2.0 started successfully (PID 28148)\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<report>\r\n  <buildInformation>\r\n    <releaseDetails id=\"core\" version=\"1.20.2\" buildDate=\"2022-05-19T08:23:00Z\"></releaseDetails>\r\n    <releaseDetails id=\"validation-model\" version=\"1.20.2\" buildDate=\"2022-05-19T08:27:00Z\"></releaseDetails>\r\n    <releaseDetails id=\"gui\" version=\"1.20.3\" buildDate=\"2022-05-19T09:10:00Z\"></releaseDetails>\r\n  </buildInformation>\r\n  <jobs>\r\n    <job>\r\n      <item size=\"127841\">\r\n        <name>D:\\local\\Temp\\VeraPdf0c159e8c-6ece-4030-a2ea-f99ac72a197a.pdf</name>\r\n      </item>\r\n      <validationReport profileName=\"PDF/A-2A validation profile\" statement=\"PDF file is not compliant with Validation Profile requirements.\" isCompliant=\"false\">\r\n        <details passedRules=\"127\" failedRules=\"2\" passedChecks=\"21433\" failedChecks=\"4\">\r\n          <rule specification=\"ISO 19005-2:2011\" clause=\"6.6.2.3\" testNumber=\"7\" status=\"failed\" passedChecks=\"0\" failedChecks=\"2\">\r\n            <description>All properties specified in XMP form shall use either the predefined schemas defined in the XMP Specification,\r\n\t\t\tISO 19005-1 or this part of ISO 19005, or any extension schemas that comply with 6.6.2.3.2.</description>\r\n            <object>XMPProperty</object>\r\n            <test>(isPredefinedInXMP2005 == true || isDefinedInMainPackage == true || isDefinedInCurrentPackage == true) &amp;&amp; isValueTypeCorrect == true</test>\r\n            <check status=\"failed\">\r\n              <context>root/document[0]/metadata[0](6 0 obj PDMetadata)/XMPPackage[0]/Properties[1](http://purl.org/dc/elements/1.1/ - dc:language)</context>\r\n              <errorMessage>An XMP property is either not not pre-defined, is not defined in any extension schema, or has invalid type.</errorMessage>\r\n            </check>\r\n            <check status=\"failed\">\r\n              <context>root/document[0]/metadata[0](6 0 obj PDMetadata)/XMPPackage[0]/Properties[2](http://purl.org/dc/elements/1.1/ - dc:date)</context>\r\n              <errorMessage>An XMP property is either not not pre-defined, is not defined in any extension schema, or has invalid type.</errorMessage>\r\n            </check>\r\n          </rule>\r\n          <rule specification=\"ISO 19005-2:2011\" clause=\"6.2.11.4\" testNumber=\"4\" status=\"failed\" passedChecks=\"0\" failedChecks=\"2\">\r\n            <description>If the FontDescriptor dictionary of an embedded CID font contains a CIDSet stream, then it shall identify all CIDs which are present in the font program,\r\n\t\t\tregardless of whether a CID in the font is referenced or used by the PDF or not.</description>\r\n            <object>PDCIDFont</object>\r\n            <test>fontFile_size == 0 || fontName.search(/[A-Z]{6}\\+/) != 0 || CIDSet_size == 0 || cidSetListsAllGlyphs == true</test>\r\n            <check status=\"failed\">\r\n              <context>root/document[0]/pages[0](124 0 obj PDPage)/contentStream[0](122 0 obj PDContentStream)/operators[600]/font[0](EAAAAA+FrutigerNextCom-Regular)/DescendantFonts[0](EAAAAA+FrutigerNextCom-Regular)</context>\r\n              <errorMessage>A CID Font subset does not define CIDSet entry in its Descriptor dictionary</errorMessage>\r\n            </check>\r\n            <check status=\"failed\">\r\n              <context>root/document[0]/pages[0](124 0 obj PDPage)/contentStream[0](122 0 obj PDContentStream)/operators[1662]/font[0](EAAAAB+FrutigerNextCom-Bold)/DescendantFonts[0](EAAAAB+FrutigerNextCom-Bold)</context>\r\n              <errorMessage>A CID Font subset does not define CIDSet entry in its Descriptor dictionary</errorMessage>\r\n            </check>\r\n          </rule>\r\n        </details>\r\n      </validationReport>\r\n      <duration start=\"1654204890553\" finish=\"1654204895455\">00:00:04.902</duration>\r\n    </job>\r\n  </jobs>\r\n  <batchSummary totalJobs=\"1\" failedToParse=\"0\" encrypted=\"0\" outOfMemory=\"0\" veraExceptions=\"0\">\r\n    <validationReports compliant=\"0\" nonCompliant=\"1\" failedJobs=\"0\">1</validationReports>\r\n    <featureReports failedJobs=\"0\">0</featureReports>\r\n    <repairReports failedJobs=\"0\">0</repairReports>\r\n    <duration start=\"1654204890018\" finish=\"1654204895549\">00:00:05.531</duration>\r\n  </batchSummary>\r\n</report>\r\n";

        [Fact]
        public void ShouldFilterApplicationInsightConsolePrefix()
        {
            var filteredAzureConsoleOutputSample = new ApplicationInsightsJavaAgentOutputFilter().Filter(azureConsoleOutputSample);

            var xmlDocument = new XmlDocument();
            xmlDocument.LoadXml(filteredAzureConsoleOutputSample);
            Assert.True(xmlDocument.HasChildNodes);
        }
    }
}